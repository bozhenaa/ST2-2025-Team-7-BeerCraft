@model BeerCraftMVC.Models.ViewModels.Recipes.AddRecipeViewModel
@{
    ViewData["Title"] = "Create New Recipe";
}
@section Styles {
    <link rel="stylesheet" href="~/css/add-recipe.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
}

<h1>@ViewData["Title"]</h1>

<div class="form-wrapper">

    <div class="form-content">
        <form asp-action="Create" method="post">
            <div asp-validation-summary="All" class="text-danger mb-3" ></div>

            <div class="mb-3">
                <label asp-for="Name" class="form-label"></label>
                <input asp-for="Name" class="form-control" placeholder="e.g., Classic American Pale Ale" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Description" class="form-label"></label>
                <textarea asp-for="Description" class="form-control" rows="5" placeholder="Describe your recipe..."></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>

            <h4 class="mt-4">Ingredients</h4>
            <div id="ingredientsList">
            </div>

            <button type="button" id="addIngredientBtn" class="btn btn-outline-secondary mb-3">
                <i class="fas fa-plus"></i> Add Ingredient
            </button>

            <div class="form-actions">
                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Save Recipe</button>
            </div>
        </form>
    </div>

    <div id="ingredientRowTemplate" class="ingredient-row-modern" style="display: none;" data-index="__INDEX__">
        <div class="ingredient-fields">
            <div class="field-group ingredient-name-group">
                <label for="Ingredients___INDEX___IngredientId" class="form-label">Ingredient</label>
                <select name="Ingredients[__INDEX__].IngredientId" id="Ingredients___INDEX___IngredientId" class="form-select ingredient-select">
                    <option value="">-- Select Ingredient --</option>
                    @foreach (var item in Model.AvailableIngredients)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>
                <span class="text-danger field-validation-valid" data-valmsg-for="Ingredients[__INDEX__].IngredientId"></span>
            </div>
            <div class="field-group ingredient-quantity-group">
                <label for="Ingredients___INDEX___Quantity" class="form-label">Quantity</label>
                <input name="Ingredients[__INDEX__].Quantity" id="Ingredients___INDEX___Quantity" type="number" step="any" class="form-control" placeholder="e.g., 5.5" />
                <span class="text-danger field-validation-valid" data-valmsg-for="Ingredients[__INDEX__].Quantity"></span>
            </div>
            <div class="field-group ingredient-unit-group">
                <label for="Ingredients___INDEX___Unit" class="form-label">Unit</label>
                <select name="Ingredients[__INDEX__].Unit" id="Ingredients___INDEX___Unit" class="form-select">

                    @foreach (var item in Model.AvailableUnits)
                    {
                        <option value="@item">@item</option>

                    }
                </select>
                <span class="text-danger field-validation-valid" data-valmsg-for="Ingredients[__INDEX__].Unit"></span>
            </div>
        </div>
        <div class="ingredient-remove-action">
            <button type="button" class="btn-remove-ingredient" aria-label="Remove Ingredient">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <aside class="info-panel">
        <h3>Recipe Tips</h3>
        <p>A great recipe starts with quality ingredients and accurate measurements.</p>
        <ul>
            <li>Ensure your equipment is sanitized.</li>
            <li>Control your fermentation temperature.</li>
            <li>Don't be afraid to experiment!</li>
        </ul>
        <p>The description field supports notes about your process, taste, and results.</p>
    </aside>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ingredientsList = document.getElementById('ingredientsList');
            const addIngredientBtn = document.getElementById('addIngredientBtn');
            const templateRow = document.getElementById('ingredientRowTemplate');

            if (!ingredientsList || !addIngredientBtn || !templateRow) {
                console.error("ERROR: Required elements not found.");
                return;
            }

                    function addNewRow() {
            const existingRows = ingredientsList.querySelectorAll('.ingredient-row-modern:not(#ingredientRowTemplate)');
            const newIndex = existingRows.length;
            const newRow = templateRow.cloneNode(true);

            newRow.removeAttribute('id');
            newRow.style.display = 'flex';
            newRow.dataset.index = newIndex;

            updateAttributes(newRow, newIndex);

            
            const unitSelect = newRow.querySelector('select[name$=".Unit"]');
            if (unitSelect) {
                unitSelect.value = "g"; 
            }

            ingredientsList.appendChild(newRow);
            updateRemoveButtonsVisibility();

            const form = ingredientsList.closest('form');
            if (form && typeof $ !== 'undefined' && $.validator && $.validator.unobtrusive) {
                $.validator.unobtrusive.parse(form);
            }
        }

            function updateAttributes(row, index) {

                let html = row.innerHTML;

                        html = html.replace(/\[__INDEX__\]/g, `[${index}]`);
                        html = html.replace(/___INDEX___/g, index);


                        row.innerHTML = html;
            }

            function reindexRows() {
                const rows = ingredientsList.querySelectorAll('.ingredient-row-modern:not(#ingredientRowTemplate)');

                rows.forEach((row, newIndex) => {
                    const oldIndex = parseInt(row.dataset.index, 10);
                    row.dataset.index = newIndex;
                    if (oldIndex === newIndex) return;

                    
                    const oldIndexRegex = new RegExp(`\\[${oldIndex}\\]`, 'g');
                    const oldIdRegex = new RegExp(`_${oldIndex}_`, 'g'); 

                  
                    let html = row.innerHTML;
                    html = html.replace(oldIndexRegex, `[${newIndex}]`);
                    html = html.replace(oldIdRegex, `_${newIndex}_`);
                    row.innerHTML = html;
                });
            }

            function updateRemoveButtonsVisibility() {
                const rows = ingredientsList.querySelectorAll('.ingredient-row-modern:not(#ingredientRowTemplate)');
                const showRemove = rows.length > 1;
                rows.forEach(row => {
                    const removeBtn = row.querySelector('.btn-remove-ingredient');
                    if (removeBtn) {
                        removeBtn.style.display = showRemove ? 'flex' : 'none';
                    }
                });
            }

            ingredientsList.addEventListener('click', function (e) {
                const removeButton = e.target.closest('.btn-remove-ingredient');
                if (removeButton) {
                    e.preventDefault();
                    const rowToRemove = removeButton.closest('.ingredient-row-modern');
                    if (rowToRemove) {
                        rowToRemove.remove();
                        reindexRows();
                        updateRemoveButtonsVisibility();
                    }
                }
            });

            addIngredientBtn.addEventListener('click', addNewRow);

            addNewRow();
            updateRemoveButtonsVisibility();
        });
                const form = document.querySelector('form');
        form.addEventListener('submit', (e) => {
            const data = new FormData(form);
            console.log("🔍 FormData:");
            for (let [key, val] of data.entries()) {
                console.log(key, "=>", val);
            }
        });
    </script>
}